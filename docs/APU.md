# APU

The Audio Processing Unit (APU) is responsible for producing sound. Sound consists of waves that our bodies are able to interpret audio. In the real world sound exists as analog signals, in the digital world we take samples at every some regular interval to construct a digital sound wave. The APU has 4 channels which it samples and mixes to produce output sound.

## Registers
- `nrx0`: Channel specific register
- `nrx1`: Length timer
- `nrx2`: Volume and envelope
- `nrx3`: Period
- `nrx4`: Trigger and length timer enable 
- `nr52`: Audio master control
- `nr51`: Sound panning
- `nr50`: Master volume and VIN pinning

`nrx0`-`nrx4` registers exist for each channel where `x` is the channel number.

## Channels
The APU is often referred to as a series of counters, a value is counted down from and some action is triggered when its reaches 0. We have 2 square channels, one wave channel and a noise channel.

### Frame Sequencer
The frame sequencer is responsible for creating a clock signal for the APU. The gameboy master clock runs at 4,193,304 Hz, the APU runs at a clock rate of 512Hz. The master clock is divided by 8192 to achieve this. The APU is ticked every time the CPU is, at each 8192th tick an action may be triggered.

On each APU clock cycle the `triggerLength`, `triggerEnvelope`, and `triggerSweep` updated.


| Cycle | Length Counter | Volume Envelope | Sweep |
|-------|----------------|-----------------|-------|
| 0     | True           | -               | -     |
| 1     | -              | -               | -     |
| 2     | True           | -               | True  |
| 3     | -              | -               | -     |
| 4     | True           | -               | -     |
| 5     | -              | -               | -     |
| 6     | True           | -               | True  |
| 7     | -              | True            | -     |


### Length Timer (Length Timer Action)
The length timer function controls how long a sound will play by enabling and disabling the channel. The function will return true until the channel `lengthTimer` value is less than or equal to 0 at which point it will disable the channel.

### Volume Envelope (Envelope Action)
The envelope action is used to control the waves amplitude. This creates fade in, fade, out, and sustained sound. We read in how fast and which direction to increment or decrement from our `nrx2` register.

### Square Channels
The square channels are rectangular waves based on the duty cycle which indicates how long the wave will be at 1 or 0.

|     Value      | Duty cycle | Waveform |
| -------------- | ---------- | ---------|
| 00             | 12.5 %     | 00000001 |
| 01             | 25 %       | 10000001 |
| 10             | 50 %       | 10000111 |
| 11             | 75 %       | 01111110 |

When the timer action is triggered the duty cycle is incremented.

A sample for the channel is generated by getting the current value from the duty matrix and multiplying it by the envelope.

### Wave Channel
The wave channel has a programmable waveform. Games write to the waveform RAM which is read by the APU. A sample value is extracted from the wavefrom RAM shifted and returned.

### Noise Channel
The noise channel generates psuedo-random noise by utilizing a Linear Feedback Shift Register (LFSR). Register `nrx3` configures the time period and divisor. When the action is triggered then LFSR is right shifted one bit and the high bit is set by XORing bit 0 and 1. A sample is extracted by taking the lowest bit of the LFSR register and multiplying it by the envelope volume. 
